<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Scoreboard — Live</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{background:#05060a;color:#fff;font-family:Inter,Arial;padding:32px}
    h1{font-size:48px;text-align:center;margin-bottom:20px}
    table{width:90%;margin:0 auto;border-collapse:collapse;font-size:28px}
    th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,0.06);text-align:left}
    th{font-weight:700;font-size:22px;opacity:0.9}
    td.rank{width:80px;font-weight:800}
    .muted{opacity:0.7;font-size:16px;text-align:center;margin-top:8px}
  </style>
</head>
<body>
  <h1>TOP 10 — LIVE</h1>
  <table id="board">
    <thead>
      <tr><th>Rank</th><th>Name</th><th>Score</th><th>When</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="muted">Connected to Firebase Realtime Database • Updates automatically</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getDatabase, ref, query, orderByChild, limitToLast, onValue
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA6MdK6DcJVKxm1LkYQ7Ukny8t-ThxcV8k",
      authDomain: "malwaregame-777.firebaseapp.com",
      projectId: "malwaregame-777",
      storageBucket: "malwaregame-777.appspot.com",
      messagingSenderId: "584958029606",
      appId: "1:584958029606:web:701168c7ce4be3f1df1be7",
      measurementId: "G-WHPETJHDLX",
      databaseURL: "https://malwaregame-777-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Query top 10 by score (limitToLast + orderByChild('score'))
    const scoresRef = ref(db, 'scores');
    const topQuery = query(scoresRef, orderByChild('score'), limitToLast(10));

    const tbody = document.querySelector('#board tbody');

    function renderList(items){
      // items is an array of objects { name, score, ts }
      // sort descending by score
      items.sort((a,b) => b.score - a.score);
      tbody.innerHTML = '';
      items.forEach((p,i) => {
        const when = p.ts ? new Date(p.ts).toLocaleString() : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="rank">${i+1}</td>
                        <td>${escapeHtml(p.name || '—')}</td>
                        <td>${p.score ?? 0}</td>
                        <td>${when}</td>`;
        tbody.appendChild(tr);
      });
    }

    // Listen for realtime updates
    onValue(topQuery, snap => {
      const arr = [];
      snap.forEach(child => {
        const v = child.val();
        // If timestamp is serverTimestamp(), it may appear as null until resolved,
        // so keep child's priority/time as fallback.
        arr.push({ name: v.name, score: v.score, ts: v.ts || null });
      });
      renderList(arr);
    }, err => {
      console.error('firebase read err', err);
      // fallback — try localStorage
      const local = JSON.parse(localStorage.getItem('scoreboard') || '[]');
      renderList(local);
    });

    // small helper
    function escapeHtml(s){
      return (s+'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
  </script>
</body>
</html>

